worker_processes auto;
events { worker_connections 4096; }

http {

  resolver 10.89.0.1 valid=30s ipv6=off;  # Podman DNS (컨테이너 resolv.conf 참고)

  log_format fcfs '$msec $request $status $request_time $upstream_response_time '
                  '$request_id $remote_addr $http_x_forwarded_for';
  access_log /var/log/nginx/access.log fcfs;

  real_ip_header X-Forwarded-For;
  set_real_ip_from 0.0.0.0/0;
  
  lua_package_path '/etc/openresty/lua/?.lua;/usr/local/openresty/lualib/?.lua;;';
  lua_shared_dict lua_cache 1m;

  map $host $backend_upstream {
    default http://backend:5800;
  }

  limit_req_zone $binary_remote_addr zone=fcfs:10m rate=5r/s;

  server {
    listen 80;

    location = /fcfs/join {
      limit_req zone=fcfs burst=30 nodelay;

      access_by_lua_block {
        local redis_env = require 'redis_env'
        redis_env.process_request()
      }

      proxy_set_header X-Request-Id $request_id;
      proxy_set_header X-Real-IP    $realip_remote_addr;
      proxy_set_header X-User-Id    $http_x_user_id;
      proxy_set_header X-Gateway-Version 1;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_pass $backend_upstream/api/v1/seats/reservation/fcfs;

      # body_filter_by_lua_block / header_filter_by_lua_block 그대로
    }

    # Health endpoints (support both /health and /healthz)
    location = /health { default_type text/plain; return 200 "ok\n"; }
    
    # Redis debug test endpoint
    location = /redis-test {
      content_by_lua_file /etc/openresty/lua/redis_test.lua;
    }
    
    # Redis connection debug endpoint
    location = /redis-debug {
      content_by_lua_file /etc/openresty/lua/redis_debug.lua;
    }

    # Normalize seat list path (backend expects trailing slash). 307 preserves method for potential POSTs.
    location = /api/v1/seats {
      return 307 /api/v1/seats/;
    }

    # Generic API pass-through so that GET /api/v1/seats and related endpoints
    # defined in docs/api-spec.md are accessible through the gateway.
    # FCFS 예약 전용 엔드포인트 외 일반 좌석 조회용.
    location /api/ {
      proxy_set_header X-Request-Id $request_id;
      proxy_set_header X-Real-IP    $realip_remote_addr;
      proxy_set_header X-Admin-Token $http_x_admin_token;
      proxy_set_header X-Gateway-Version 1;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_pass $backend_upstream;
    }
  }
}